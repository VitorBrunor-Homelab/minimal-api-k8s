# .github/workflows/build-and-deploy.yml

name: Build e Deploy com K3s via GitOps

# Gatilho
on:
    push:
        branches: [ "main" ]

jobs:
    build-and-push:
        # A job roda com meu runner auto-hospedado
        runs-on: self-hosted
        
        steps:
        # 1 - Baixa o c처digo da API para o runner
        - name: Checkout API Repository
          uses: actions/checkout@v4
        
        # 2 - Faz login no Harbor
        - name: Login no Harbor
          uses: docker/login-action@v3
          with:
            registry: ${{ secrets.HARBOR_URL }}
            username: ${{ secrets.HARBOR_USER }}
            password: ${{ secrets.HARBOR_PASSWORD }}
            
        # 3 - Constr처i e envia a imagem para o Harbor
        # As tags ser찾o o hash do commit do git
        - name:  Build e push da Docker imagem
          id: build-and-push
          uses: docker/build-push-action@v5
          with:
            context: ./MinimalApiK8s
            push: true
            tags: ${{ secrets.HARBOR_URL }}/test-api/minimal-api:${{ github.sha }}  
            
        # 4 - Baixa o reposit처rio de Manifestos
        - name: Checkout Repositorios de Manifestos
          uses: actions/checkout@v4
          with:
            repository: VitorBrunor-Homelab/homelab-k8s-manifests
            token: ${{ secrets.GH_PAT }}
            path: manifests 
            
        # 5 - Update e Commit
        - name: Update and Commit Manifests
            run: cd manifests &&
                 sed -i "s|image: .*|image: ${{ secrets.HARBOR_URL }}/test-api/minimal-api:${{ github.sha }}|g" minimal-api/deployment.yaml && 
                 git config user.name "GitHub Actions" && 
                 git config user.email "actions@github.com" && 
                 git commit -am "Update image for minimal-api to tag ${{ github.sha }}" && 
                 git push